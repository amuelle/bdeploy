<ng-template #activitiesPopup>
  <mat-card
    appearance="outlined"
    [class.local-activity-collapsed]="!expanded"
    [class.local-activity-expanded]="expanded"
    class="local-activity-popup-sizing flex flex-col gap-1 p-2.5"
  >
    <app-bd-activities></app-bd-activities>
  </mat-card>
</ng-template>

<div class="bd-rect-card local-sizing local-nav-bar flex flex-col gap-1">
  <!-- Logo & Expand Button -->
  <div class="flex justify-center items-center pb-4 min-h-[100px] h-[100px]">
    <div class="local-hamburger-button">
      <div
        class="hamburger hamburger--arrow"
        [ngClass]="{ 'is-active': expanded }"
        (click)="expanded = !expanded"
      >
        <span class="hamburger-box">
          <span class="hamburger-inner"></span>
        </span>
      </div>
    </div>
    <h2
      *ngIf="expanded"
      class="local-header"
      [@delayedFadeIn]="{ value: 'dummy', params: { delay: '0.15s' } }"
      [@delayedFadeOut]="{ value: 'dummy', params: { delay: '0s' } }"
    >
      BDeploy
    </h2>
  </div>

  <!-- Groups -->
  <app-main-nav-button
    icon="view_carousel"
    text="Instance Groups"
    [collapsed]="!expanded"
    [route]="['/groups/browser']"
  ></app-main-nav-button>

  <app-main-nav-button
    icon="storage"
    *ngIf="!(authService.isGlobalExclusiveReadClient$ | async)"
    text="Software Repositories"
    [collapsed]="!expanded"
    [route]="['/repositories/browser']"
  ></app-main-nav-button>

  <mat-divider class="local-divider"></mat-divider>
  <app-main-nav-button
    *ngIf="!(authService.isCurrentScopedExclusiveReadClient$ | async)"
    [visible]="!!(areas.groupContext$ | async)"
    icon="settings_system_daydream"
    text="Instances"
    [collapsed]="!expanded"
    [route]="['/instances', 'browser', areas.groupContext$.value]"
  ></app-main-nav-button>

  <app-main-nav-button
    *ngIf="!(authService.isCurrentScopedExclusiveReadClient$ | async)"
    [visible]="!!(areas.groupContext$ | async)"
    icon="apps"
    text="Products"
    [collapsed]="!expanded"
    [route]="['/products', 'browser', areas.groupContext$.value]"
  ></app-main-nav-button>

  <app-main-nav-button
    [visible]="!!(areas.groupContext$ | async)"
    icon="computer"
    text="Client Applications"
    [collapsed]="!expanded"
    [route]="['/groups', 'clients', areas.groupContext$.value]"
  ></app-main-nav-button>

  <app-main-nav-button
    *ngIf="(cfgService.isCentral$ | async) && !(authService.isCurrentScopedExclusiveReadClient$ | async)"
    [visible]="!!(areas.groupContext$ | async)"
    icon="dns"
    text="Managed Servers"
    [collapsed]="!expanded"
    [route]="['/servers', 'browser', areas.groupContext$.value]"
    [disabled]="!(authService.isCurrentScopeAdmin$ | async)"
    [matTooltip]="(authService.isCurrentScopeAdmin$ | async) ? null : 'Only administrators can maintain managed server configuration'"
    matTooltipPosition="right"
  ></app-main-nav-button>

  <app-main-nav-button
    *ngIf="!(authService.isCurrentScopedExclusiveReadClient$ | async)"
    [visible]="!!(areas.groupContext$ | async)"
    icon="inventory_2"
    text="Systems"
    [collapsed]="!expanded"
    [route]="['/systems', 'browser', areas.groupContext$.value]"
  ></app-main-nav-button>

  <!-- Instance -->

  <mat-divider
    class="local-divider"
    *ngIf="areas.groupContext$ | async"
    [@delayedFadeIn]="{ value: 'dummy', params: { delay: '0s' } }"
    [@delayedFadeOut]="{ value: 'dummy', params: { delay: '0s' } }"
  ></mat-divider>

  <app-main-nav-button
    [visible]="!!(areas.instanceContext$ | async)"
    icon="dashboard"
    text="Instance Dashboard"
    [collapsed]="!expanded"
    [route]="['/instances', 'dashboard', areas.groupContext$.value, areas.instanceContext$.value]"
  ></app-main-nav-button>

  <app-main-nav-button
    [visible]="!!(areas.instanceContext$ | async)"
    svgIcon="instance-settings"
    text="Instance Configuration"
    [collapsed]="!expanded"
    [route]="['/instances', 'configuration', areas.groupContext$.value, areas.instanceContext$.value]"
    [disabled]="!(authService.isCurrentScopeWrite$ | async)"
    [matTooltip]="(authService.isCurrentScopeWrite$ | async) ? null : 'Insufficient permissions to change configuration'"
    matTooltipPosition="right"
  ></app-main-nav-button>

  <app-main-nav-button
    [visible]="!!(areas.instanceContext$ | async)"
    icon="source"
    text="Data Files"
    [collapsed]="!expanded"
    [route]="['/instances', 'data-files', areas.groupContext$.value, areas.instanceContext$.value]"
  ></app-main-nav-button>

  <app-main-nav-button
    [visible]="!!(areas.instanceContext$ | async)"
    icon="history"
    text="Instance History"
    [collapsed]="!expanded"
    [route]="['/instances', 'history', areas.groupContext$.value, areas.instanceContext$.value]"
  ></app-main-nav-button>

  <!-- Footer -->
  <div class="flex-auto"></div>
  <div class="local-server-type-wrapper-expanded" *ngIf="expanded">
    <span
      class="local-server-type"
      [@delayedFadeIn]="{ value: 'dummy', params: { delay: '0.15s' } }"
      >{{ cfgService.config.mode }}</span
    >
  </div>
  <div
    *ngIf="expanded"
    [@delayedFadeIn]="{ value: 'dummy', params: { delay: '0.15s' } }"
    [appBdPopup]="activitiesPopup"
    appBdPopupPosition="right-above"
    [class.bd-disabled-text]="!(activities.activities$ | async)?.length"
    [class.bd-accent-text]="!!(activities.activities$ | async)?.length"
    class="cursor-pointer flex justify-start items-center pb-2.5"
  >
    <mat-spinner
      class="bd-inherited-spinner"
      [mode]="!!(activities.activities$ | async)?.length ? 'indeterminate' : 'determinate'"
      [value]="!(activities.activities$ | async)?.length ? 100 : 0"
      [diameter]="24"
    ></mat-spinner>
    <div
      *ngIf="!!(activities.activities$ | async)?.length"
      class="bd-text pl-2.5"
    >
      {{ (activities.activities$ | async)?.length }} Activities.
    </div>
    <div
      *ngIf="!(activities.activities$ | async)?.length"
      class="bd-disabled-text pl-2.5"
    >
      No Activities.
    </div>
  </div>

  <div
    *ngIf="!expanded && !!(activities.activities$ | async)?.length"
    [@delayedFadeIn]="{ value: 'dummy', params: { delay: '0.15s' } }"
    [appBdPopup]="activitiesPopup"
    appBdPopupPosition="right-above"
    class="bd-accent-text cursor-pointer flex pl-1.5"
  >
    <mat-spinner class="bd-inherited-spinner" [diameter]="24"></mat-spinner>
  </div>

  <div *ngIf="!expanded" class="local-short-version">
    <div
      class="w-9"
      [@delayedFadeIn]="{ value: 'dummy', params: { delay: '0.15s' } }"
    >
      {{ cfgService.config.version | formatVersionShort }}
    </div>
  </div>
  <div
    *ngIf="expanded"
    class="local-footer flex flex-col gap-1"
    [@delayedFadeIn]="{ value: 'dummy', params: { delay: '0.15s' } }"
  >
    <div class="grid grid-cols-[50px_auto] gap-1">
      <span>Version:</span>
      <span>{{ cfgService?.config?.version | formatVersion }}</span>
    </div>
  </div>
  <app-bd-button
    *ngIf="cfgService.isNewGitHubReleaseAvailable$ | async"
    icon="system_update"
    text="New Release"
    color="toolbar"
    [collapsed]="!expanded"
    tooltip="right"
    [isToggle]="true"
    [toggleOnClick]="false"
    (click)="goToGitHub()"
  ></app-bd-button>
  <mat-divider class="local-divider"></mat-divider>
  <app-main-nav-button
    icon="settings"
    text="Administration"
    [collapsed]="!expanded"
    [route]="['/admin/']"
    [disabled]="!(authService.isGlobalAdmin$ | async)"
  ></app-main-nav-button>
  <a
    href="/assets/doc/index.html"
    target="_blank"
    class="bd-button-link"
    aria-label="Help"
    class=""
  >
    <app-bd-button
      class="flex"
      icon="help_outline"
      text="Help"
      color="toolbar"
      [collapsed]="!expanded"
    ></app-bd-button>
  </a>
</div>
